/*!
 * Copyright 2014 Strahinya Radich.
 *
 * This file is part of HexFontEd.
 *
 * HexFontEd is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * HexFontEd is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Foobar.  If not, see <http://www.gnu.org/licenses/>.
 */
(function(a){a.hexfonted=function(d,c){var f={fontListWidth:400,fontListHeight:400,charEditorWidth:250,charEditorHeight:250,hexFontCharWidth:8,hexFontCharHeight:16,pixelsProportional:true,listEditorGap:20,pixelFilledColor:"#000",pixelEmptyColor:"#fff",charEditorOutOfBoundsColor:"#ccc",charEditorInBoundsColor:"#fff"};var b=a(d);var e=this;e.settings={};e.charArray=[];e.init=function(){e.settings=a.extend({},f,c);for(var i=0;i<e.settings.hexFontCharHeight;i++){e.charArray[i]=[];for(var h=0;h<e.settings.hexFontCharWidth;h++){e.charArray[i].push(0)}}e.fixedColor=null;e.lastColor=null;e.canvasEffectiveWidth=e.settings.charEditorWidth;e.canvasEffectiveHeight=e.settings.charEditorHeight;e.pixelWidth=Math.floor(e.settings.charEditorWidth/e.settings.hexFontCharWidth);e.pixelHeight=Math.floor(e.settings.charEditorHeight/e.settings.hexFontCharHeight);e.pixelStartX=0;e.pixelStartY=0;if(e.settings.pixelsProportional){var g=Math.min(e.pixelWidth,e.pixelHeight);e.canvasEffectiveWidth=e.settings.hexFontCharWidth*g;e.canvasEffectiveHeight=e.settings.hexFontCharHeight*g;e.pixelStartX=(e.settings.charEditorWidth-e.canvasEffectiveWidth)/2;e.pixelStartY=(e.settings.charEditorHeight-e.canvasEffectiveHeight)/2;e.pixelWidth=g;e.pixelHeight=g;console.log("hfe: pixelSize = "+g)}b.addClass("hexfonted");e.createUI();e.hatchPattern=b.find(".hfe-editor-wrapper canvas").createPattern({width:5,height:5,source:function(j){a(this).drawLine({strokeStyle:e.settings.charEditorOutOfBoundsColor,strokeWidth:1,x1:0,y1:0,x2:5,y2:5})}});e.drawBackground();e.updateHex();e.initEvents()};e.createUI=function(){a('<nav class="navbar navbar-default navbar-static" role="navigation"/>').append(a('<div class="container-fluid"/>').append(a('<div class="navbar-header"/>').append(a('<button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".hfe-navbar-collapse"/>').append('<span class="sr-only">Toggle navigation</span>').append('<span class="icon-bar"/>').append('<span class="icon-bar"/>').append('<span class="icon-bar"/>')).append('<a class="navbar-brand" href="#">HexFontEd</a>')).append(a('<div class="collapse navbar-collapse hfe-navbar-collapse"/>').append(a('<ul class="hfe-menu nav navbar-nav"/>').append(a('<li class="dropdown"/>').append('<a data-toggle="dropdown" class="dropdown-toggle" href="#" id="hfe-font-menu">Font</a>').append(a('<ul class="dropdown-menu" role="menu" aria-labelledby="hfe-font-menu"/>').append(a("<li/>").append('<a id="hfe-font-new-item" href="#">New</a>')).append(a("<li/>").append('<a id="hfe-font-open-item" href="#">Open...</a>')).append(a("<li/>").append('<a id="hfe-font-save-item" href="#">Save...</a>')))).append(a('<li class="dropdown"/>').append('<a data-toggle="dropdown" class="dropdown-toggle" href="#" id="hfe-edit-menu">Edit</a>').append(a('<ul class="dropdown-menu" role="menu" aria-labelledby="hfe-edit-menu"/>').append(a("<li/>").append('<a id="hfe-edit-copy-item" href="#">Copy</a>')).append(a("<li/>").append('<a id="hfe-edit-cut-item" href="#">Cut</a>')).append(a("<li/>").append('<a id="hfe-edit-paste-item" href="#">Paste</a>'))))))).appendTo(b);var i=a('<div class="hfe-list-wrapper"/>').appendTo(b);var h=parseInt(i.css("padding-left"))+parseInt(i.css("padding-right"));i.remove();i=a('<div class="hfe-editor-wrapper"/>').appendTo(b);var g=parseInt(i.css("padding-left"))+parseInt(i.css("padding-right"));i.remove();i=null;a('<div class="container"/>').append(a('<div class="col-sm-12 col-lg-12"/>').append(a('<div class="hfe-list-container" style="width:'+(e.settings.fontListWidth+h+2)+'px"/>').append(a('<div class="hfe-list-wrapper"/>').append('<canvas width="'+e.settings.fontListWidth+'" height="'+e.settings.fontListHeight+'"/>'))).append(a('<div class="hfe-editor-container" style="width: '+(e.settings.charEditorWidth+g+2)+"px; margin-left: "+(e.settings.fontListWidth+h+2+e.settings.listEditorGap)+'px"/>').append(a('<div class="hfe-editor-wrapper"/>').append('<canvas width="'+e.settings.charEditorWidth+'" height="'+e.settings.charEditorHeight+'"/>')).append(a('<div class="container-fluid"/>').append('<button type="button" style="margin-top: 15px" class="btn btn-default btn-sm hfe-clear-button">Clear</button>').append(a('<dl class="hfe-properties"/>').append("<dt>Code</dt>").append('<dd class="hfe-properties-code">00</dd>').append("<dt>Hex</dt>").append('<dd class="hfe-properties-hex">000000003E0808087F49494949494949</dd>').append("<dt>Position</dt>").append('<dd class="hfe-properties-position">(0, 0)</dd>').append("<dt>Click</dt>").append('<dd class="hfe-properties-click">(0, 0)</dd>'))))).appendTo(b);a('<div class="modal fade" id="hfe-confirm-clear-dialog" tabindex="-1" role="dialog" aria-labelledby="hfe-confirm-clear-dialog-title" aria-hidden="true"/>').append(a('<div class="modal-dialog"/>').append(a('<div class="modal-content"/>').append(a('<div class="modal-header"/>').append('<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>').append('<h4 class="modal-title" id="hfe-confirm-clear-dialog-title">Clear character</h4>').append(a('<div class="modal-body"/>').append("<p>Are you sure you want to clear the current character?</p>").append(a('<div class="modal-footer"/>').append('<button type="button" class="btn btn-default hfe-confirm-clear-dialog-no-button" data-dismiss="modal">No, keep it</button>').append('<button type="button" class="btn btn-danger hfe-confirm-clear-dialog-yes-button" data-dismiss="modal">Yes, clear the character</button>')))))).appendTo(b)};e.initEvents=function(){b.find(".hfe-editor-wrapper>canvas").on("mousemove",e.editorOnMouseMove);b.find(".hfe-editor-wrapper>canvas").on("mousedown",e.editorOnMouseDown);b.find(".hfe-clear-button").on("click",e.clearChar);b.find(".hfe-confirm-clear-dialog-yes-button").on("click",e.doClearChar);a(document).on("mouseup",e.editorOnMouseUp)};e.editorOnMouseMove=function(h){var g=Math.floor((h.offsetX-e.pixelStartX)/e.pixelWidth);var i=Math.floor((h.offsetY-e.pixelStartY)/e.pixelHeight);if(g>=0&&g<e.settings.hexFontCharWidth&&i>=0&&i<e.settings.hexFontCharHeight){b.find(".hfe-properties-position").text("("+g+", "+i+")");b.find(".hfe-editor-wrapper>canvas").css("cursor","crosshair")}else{b.find(".hfe-editor-wrapper>canvas").css("cursor","not-allowed")}if(e.mouseDown){if(g>=0&&g<e.settings.hexFontCharWidth&&i>=0&&i<e.settings.hexFontCharHeight){b.find(".hfe-properties-click").text("("+g+", "+i+")");e.togglePixel(g,i)}if(e.fixedColor==null){e.fixedColor=e.lastColor}}};e.editorOnMouseDown=function(h){var g=Math.floor((h.offsetX-e.pixelStartX)/e.pixelWidth);var i=Math.floor((h.offsetY-e.pixelStartY)/e.pixelHeight);if(g>=0&&g<e.settings.hexFontCharWidth&&i>=0&&i<e.settings.hexFontCharHeight){e.mouseDown=true;e.fixedColor=null;e.lastColor=null;b.find(".hfe-properties-click").text("("+g+", "+i+")");e.togglePixel(g,i);if(e.fixedColor==null){e.fixedColor=e.lastColor}}};e.editorOnMouseUp=function(g){e.mouseDown=false;e.fixedColor=null;e.lastColor=null};e.togglePixel=function(g,h){if(e.charArray[h][g]==1){color=e.settings.pixelEmptyColor}else{if(e.charArray[h][g]==0){color=e.settings.pixelFilledColor}}if(e.fixedColor!=null){color=e.fixedColor}e.charArray[h][g]=(color==e.settings.pixelFilledColor?1:0);e.lastColor=color;b.find(".hfe-editor-wrapper canvas").drawRect({fillStyle:color,x:e.pixelStartX+g*e.pixelWidth,y:e.pixelStartY+h*e.pixelHeight,fromCenter:false,width:e.pixelWidth,height:e.pixelHeight});e.updateHex()};e.drawBackground=function(){b.find(".hfe-editor-wrapper canvas").drawRect({fillStyle:e.hatchPattern,x:0,y:0,fromCenter:false,width:e.settings.charEditorWidth,height:e.settings.charEditorHeight});b.find(".hfe-editor-wrapper canvas").drawRect({fillStyle:e.settings.charEditorInBoundsColor,x:e.pixelStartX,y:e.pixelStartY,fromCenter:false,width:e.canvasEffectiveWidth,height:e.canvasEffectiveHeight})};e.updateHex=function(){var g="";for(var j=0;j<e.charArray.length;j++){var i=0;for(var h=0;h<e.charArray[j].length;h++){i|=(e.charArray[j][h]<<(e.settings.hexFontCharWidth-1-h))}g+=("00"+(i).toString(16).toUpperCase()).slice(-2)}b.find(".hfe-properties-hex").text(g)};e.clearChar=function(){a("#hfe-confirm-clear-dialog").modal()};e.doClearChar=function(){for(var h=0;h<e.settings.hexFontCharHeight;h++){for(var g=0;g<e.settings.hexFontCharWidth;g++){e.charArray[h][g]=0}}b.find(".hfe-editor-wrapper canvas").drawRect({fillStyle:e.settings.pixelEmptyColor,x:e.pixelStartX,y:e.pixelStartY,fromCenter:false,width:e.canvasEffectiveWidth,height:e.canvasEffectiveHeight});e.updateHex()};e.init()};a.hexfonted.prototype.msg={en:{}};a.fn.hexfonted=function(b){return this.each(function(){if(a(this).data("hexfonted")==undefined){var c=new a.hexfonted(this,b);a(this).data("hexfonted",c);c=null}})}}(jQuery));