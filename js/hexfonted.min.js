/*!
 * Copyright 2014 Strahinya Radich.
 *
 * This file is part of HexFontEd.
 *
 * HexFontEd is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * HexFontEd is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Foobar.  If not, see <http://www.gnu.org/licenses/>.
 */
(function(a){a.hexfonted=function(d,c){var f={fontListWidth:400,fontListHeight:400,charEditorWidth:250,charEditorHeight:250,hexFontCharWidth:8,hexFontCharHeight:16,pixelsProportional:true,fontListCharHorizontalPadding:15,fontListCharVerticalPadding:15,fontListRightScrollbarPadding:20,listEditorGap:20,pixelFilledColor:"#000",pixelEmptyColor:"#fff",charEditorOutOfBoundsColor:"#ccc",charEditorBackgroundColor:"#fff",charEditorInBoundsColor:"#fff",fontListBackgroundColor:"#fff",fontListSelectionBackgroundColor:"#eee",fontListGridColor:"#ccc"};var b=a(d);var e=this;e.settings={};e.charArray=[];e.init=function(){e.settings=a.extend({},f,c);e.fixedColor=null;e.lastColor=null;e.selectedCharX=null;e.selectedCharY=null;e.canvasEffectiveWidth=e.settings.charEditorWidth;e.canvasEffectiveHeight=e.settings.charEditorHeight;e.pixelWidth=Math.floor(e.settings.charEditorWidth/e.settings.hexFontCharWidth);e.pixelHeight=Math.floor(e.settings.charEditorHeight/e.settings.hexFontCharHeight);e.pixelStartX=0;e.pixelStartY=0;if(e.settings.pixelsProportional){var g=Math.min(e.pixelWidth,e.pixelHeight);e.canvasEffectiveWidth=e.settings.hexFontCharWidth*g;e.canvasEffectiveHeight=e.settings.hexFontCharHeight*g;e.pixelStartX=(e.settings.charEditorWidth-e.canvasEffectiveWidth)/2;e.pixelStartY=(e.settings.charEditorHeight-e.canvasEffectiveHeight)/2;e.pixelWidth=g;e.pixelHeight=g}e.numberOfChars=245;e.generateSampleChars();e.charsPerRow=Math.floor((e.settings.fontListWidth-e.settings.fontListRightScrollbarPadding)/(e.settings.hexFontCharWidth+2*e.settings.fontListCharHorizontalPadding+2));e.fontListCanvasWidth=(e.settings.hexFontCharWidth+2*e.settings.fontListCharHorizontalPadding+2)*Math.floor((e.settings.fontListWidth-e.settings.fontListRightScrollbarPadding)/(e.settings.hexFontCharWidth+2*e.settings.fontListCharHorizontalPadding+2));e.numberOfCharRows=Math.ceil(e.numberOfChars/e.charsPerRow);e.fontListCanvasHeight=(e.settings.hexFontCharHeight+2*e.settings.fontListCharVerticalPadding+2)*e.numberOfCharRows;b.addClass("hexfonted");e.createUI();e.hatchPattern=b.find(".hfe-editor-wrapper canvas").createPattern({width:5,height:5,source:function(h){a(this).drawLine({strokeStyle:e.settings.charEditorOutOfBoundsColor,strokeWidth:1,x1:0,y1:0,x2:5,y2:5})}});e.drawCharList();e.drawCharEditorBackground();e.updateCharFromList(0,0);e.initEvents()};e.createUI=function(){a('<nav class="navbar navbar-default navbar-static" role="navigation"/>').append(a('<div class="container-fluid"/>').append(a('<div class="navbar-header"/>').append(a('<button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".hfe-navbar-collapse"/>').append('<span class="sr-only">Toggle navigation</span>').append('<span class="icon-bar"/>').append('<span class="icon-bar"/>').append('<span class="icon-bar"/>')).append('<a class="navbar-brand" href="#">HexFontEd</a>')).append(a('<div class="collapse navbar-collapse hfe-navbar-collapse"/>').append(a('<ul class="hfe-menu nav navbar-nav"/>').append(a('<li class="dropdown"/>').append('<a data-toggle="dropdown" class="dropdown-toggle" href="#" id="hfe-font-menu">Font</a>').append(a('<ul class="dropdown-menu" role="menu" aria-labelledby="hfe-font-menu"/>').append(a("<li/>").append('<a id="hfe-font-new-item" href="#">New</a>')).append(a("<li/>").append('<a id="hfe-font-open-item" href="#">Open...</a>')).append(a("<li/>").append('<a id="hfe-font-save-item" href="#">Save...</a>')))).append(a('<li class="dropdown"/>').append('<a data-toggle="dropdown" class="dropdown-toggle" href="#" id="hfe-edit-menu">Edit</a>').append(a('<ul class="dropdown-menu" role="menu" aria-labelledby="hfe-edit-menu"/>').append(a("<li/>").append('<a id="hfe-edit-copy-item" href="#">Copy</a>')).append(a("<li/>").append('<a id="hfe-edit-cut-item" href="#">Cut</a>')).append(a("<li/>").append('<a id="hfe-edit-paste-item" href="#">Paste</a>'))))))).appendTo(b);var j=a('<div class="hfe-list-wrapper"/>').appendTo(b);var h=parseInt(j.css("padding-left"))+parseInt(j.css("padding-right"));var i=parseInt(j.css("padding-top"))+parseInt(j.css("padding-bottom"));j.remove();j=a('<div class="hfe-editor-wrapper"/>').appendTo(b);var g=parseInt(j.css("padding-left"))+parseInt(j.css("padding-right"));var k=parseInt(j.css("padding-top"))+parseInt(j.css("padding-bottom"));j.remove();j=null;a('<div class="container"/>').append(a('<div class="col-sm-12 col-lg-12"/>').append(a('<div class="hfe-list-container" style="width:'+(e.settings.fontListWidth+h+2)+'px"/>').append(a('<div class="hfe-list-wrapper" style="width: '+(e.settings.fontListWidth+h+2)+"px; height: "+(e.settings.fontListHeight+i+2)+'px"/>').append(a('<div class="hfe-list-wrapper-inner" style="width: '+e.fontListCanvasWidth+"px; height: "+e.fontListCanvasHeight+'px"/>').append('<canvas width="'+e.fontListCanvasWidth+'" height="'+e.fontListCanvasHeight+'"/>')))).append(a('<div class="hfe-editor-container" style="width: '+(e.settings.charEditorWidth+g+2)+"px; margin-left: "+(e.settings.fontListWidth+h+2+e.settings.listEditorGap)+'px"/>').append(a('<div class="hfe-editor-wrapper" style="width: '+(e.settings.charEditorWidth+g+2)+"px; height: "+(e.settings.charEditorHeight+k+2)+'px"/>').append('<canvas width="'+e.settings.charEditorWidth+'" height="'+e.settings.charEditorHeight+'"/>')).append(a('<div class="container-fluid"/>').append('<button type="button" style="margin-top: 15px" class="btn btn-default btn-sm hfe-clear-button">Clear</button>').append(a('<dl class="hfe-properties"/>').append("<dt>Code</dt>").append('<dd class="hfe-properties-code">00</dd>').append("<dt>Hex</dt>").append('<dd class="hfe-properties-hex">000000003E0808087F49494949494949</dd>').append("<dt>Position</dt>").append('<dd class="hfe-properties-position">(0, 0)</dd>').append("<dt>Click</dt>").append('<dd class="hfe-properties-click">(0, 0)</dd>'))))).appendTo(b);a('<div class="modal fade" id="hfe-confirm-clear-dialog" tabindex="-1" role="dialog" aria-labelledby="hfe-confirm-clear-dialog-title" aria-hidden="true"/>').append(a('<div class="modal-dialog"/>').append(a('<div class="modal-content"/>').append(a('<div class="modal-header"/>').append('<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>').append('<h4 class="modal-title" id="hfe-confirm-clear-dialog-title">Clear character</h4>').append(a('<div class="modal-body"/>').append("<p>Are you sure you want to clear the current character?</p>").append(a('<div class="modal-footer"/>').append('<button type="button" class="btn btn-default hfe-confirm-clear-dialog-no-button" data-dismiss="modal">No, keep it</button>').append('<button type="button" class="btn btn-danger hfe-confirm-clear-dialog-yes-button" data-dismiss="modal">Yes, clear the character</button>')))))).appendTo(b)};e.initEvents=function(){b.find(".hfe-editor-wrapper>canvas").on("mousemove",e.editorOnMouseMove);b.find(".hfe-editor-wrapper>canvas").on("mousedown",e.editorOnMouseDown);b.find(".hfe-clear-button").on("click",e.clearChar);b.find(".hfe-confirm-clear-dialog-yes-button").on("click",e.doClearChar);a(document).on("mouseup",e.editorOnMouseUp);b.find(".hfe-list-wrapper canvas").on("click",e.listOnClick)};e.editorOnMouseMove=function(h){var g=Math.floor((h.offsetX-e.pixelStartX)/e.pixelWidth);var i=Math.floor((h.offsetY-e.pixelStartY)/e.pixelHeight);if(g>=0&&g<e.settings.hexFontCharWidth&&i>=0&&i<e.settings.hexFontCharHeight){b.find(".hfe-properties-position").text("("+g+", "+i+")");b.find(".hfe-editor-wrapper>canvas").css("cursor","crosshair")}else{b.find(".hfe-editor-wrapper>canvas").css("cursor","not-allowed")}if(e.mouseDown){if(g>=0&&g<e.settings.hexFontCharWidth&&i>=0&&i<e.settings.hexFontCharHeight){b.find(".hfe-properties-click").text("("+g+", "+i+")");e.togglePixel(g,i)}if(e.fixedColor==null){e.fixedColor=e.lastColor}}};e.editorOnMouseDown=function(h){var g=Math.floor((h.offsetX-e.pixelStartX)/e.pixelWidth);var i=Math.floor((h.offsetY-e.pixelStartY)/e.pixelHeight);if(g>=0&&g<e.settings.hexFontCharWidth&&i>=0&&i<e.settings.hexFontCharHeight){e.mouseDown=true;e.fixedColor=null;e.lastColor=null;b.find(".hfe-properties-click").text("("+g+", "+i+")");e.togglePixel(g,i);if(e.fixedColor==null){e.fixedColor=e.lastColor}}};e.editorOnMouseUp=function(g){e.mouseDown=false;e.fixedColor=null;e.lastColor=null};e.togglePixel=function(g,i){var h;if(e.charArray[i][g]==1){h=e.settings.pixelEmptyColor}else{if(e.charArray[i][g]==0){h=e.settings.pixelFilledColor}}if(e.fixedColor!=null){h=e.fixedColor}e.charArray[i][g]=(h==e.settings.pixelFilledColor?1:0);e.lastColor=h;b.find(".hfe-editor-wrapper canvas").drawRect({fillStyle:h,x:e.pixelStartX+g*e.pixelWidth,y:e.pixelStartY+i*e.pixelHeight,fromCenter:false,width:e.pixelWidth,height:e.pixelHeight});e.updateProps();e.updateListFromChar(e.selectedCharX,e.selectedCharY)};e.drawCharEditorBackground=function(){b.find(".hfe-editor-wrapper canvas").drawRect({fillStyle:e.settings.charEditorBackgroundColor,x:0,y:0,fromCenter:false,width:e.settings.charEditorWidth,height:e.settings.charEditorHeight}).drawRect({fillStyle:e.hatchPattern,x:0,y:0,fromCenter:false,width:e.settings.charEditorWidth,height:e.settings.charEditorHeight}).drawRect({fillStyle:e.settings.charEditorInBoundsColor,x:e.pixelStartX,y:e.pixelStartY,fromCenter:false,width:e.canvasEffectiveWidth,height:e.canvasEffectiveHeight})};e.drawEditorSingleChar=function(){var h;for(var i=0;i<e.charArray.length;i++){for(var g=0;g<e.charArray[i].length;g++){if(e.charArray[i][g]==1){h=e.settings.pixelFilledColor}else{if(e.charArray[i][g]==0){h=e.settings.pixelEmptyColor}}b.find(".hfe-editor-wrapper canvas").drawRect({fillStyle:h,x:e.pixelStartX+g*e.pixelWidth,y:e.pixelStartY+i*e.pixelHeight,fromCenter:false,width:e.pixelWidth,height:e.pixelHeight})}}};e.drawCharListSingleChar=function(g,j,h){var i=e.settings.fontListBackgroundColor;if(h){i=e.settings.fontListSelectionBackgroundColor}b.find(".hfe-list-wrapper canvas").drawRect({strokeStyle:e.settings.fontListGridColor,fillStyle:i,x:g*(e.settings.hexFontCharWidth+2*e.settings.fontListCharHorizontalPadding+2),y:j*(e.settings.hexFontCharHeight+2*e.settings.fontListCharVerticalPadding+2),fromCenter:false,width:(e.settings.hexFontCharWidth+2*e.settings.fontListCharHorizontalPadding+2),height:(e.settings.hexFontCharHeight+2*e.settings.fontListCharVerticalPadding+2)})};e.drawCharList=function(){b.find(".hfe-list-wrapper canvas").drawRect({fillStyle:e.settings.fontListBackgroundColor,x:0,y:0,fromCenter:false,width:e.fontListCanvasWidth,height:e.fontListCanvasHeight});for(var h=0;h<e.numberOfCharRows;h++){for(var g=0;g<e.charsPerRow;g++){e.drawCharListSingleChar(g,h,e.selectedCharX!=null&&e.selectedCharY!=null&&e.selectedCharX==g&&e.selectedCharY==h)}}};String.prototype.splitToChunks=function(g){var i=[];for(var h=0;h<this.length;h+=g){i.push(this.substr(h,g))}return i};e.updateCharFromList=function(g,n){var l=e.getCharAt(g,n);if(l!=null){e.charArray=[];var h=l.hex.splitToChunks(2);for(var m=0;m<h.length;m++){var i=parseInt(h[m],16);var j=[];for(var k=0;k<e.settings.hexFontCharWidth;k++){j.push(i&1);i>>=1}j.reverse();e.charArray.push(j)}}e.charCode=l.code};e.updateListFromChar=function(h,m){var g="";for(var l=0;l<e.charArray.length;l++){var j=0;for(var i=0;i<e.charArray[l].length;i++){j|=(e.charArray[l][i]<<(e.settings.hexFontCharWidth-1-i))}g+=("00"+(j).toString(16).toUpperCase()).slice(-2)}var k=e.getCharAt(h,m);e.setCharAt(h,m,{code:e.charCode,hex:g})};e.listOnClick=function(h){var g=Math.floor(h.offsetX/(e.settings.hexFontCharWidth+2*e.settings.fontListCharHorizontalPadding+2));var i=Math.floor(h.offsetY/(e.settings.hexFontCharHeight+2*e.settings.fontListCharVerticalPadding+2));if(e.selectedCharX!=null&&e.selectedCharY!=null){e.drawCharListSingleChar(e.selectedCharX,e.selectedCharY,false)}e.drawCharListSingleChar(g,i,true);e.selectedCharX=g;e.selectedCharY=i;e.updateCharFromList(g,i);e.drawCharEditorBackground();e.drawEditorSingleChar();e.updateProps()};e.updateProps=function(){var g="";for(var j=0;j<e.charArray.length;j++){var i=0;for(var h=0;h<e.charArray[j].length;h++){i|=(e.charArray[j][h]<<(e.settings.hexFontCharWidth-1-h))}g+=("00"+(i).toString(16).toUpperCase()).slice(-2)}b.find(".hfe-properties-hex").text(g);b.find(".hfe-properties-code").text(e.charCode)};e.clearChar=function(){a("#hfe-confirm-clear-dialog").modal()};e.generateSampleChars=function(){e.chars=[];for(var g=0;g<e.numberOfChars;g++){e.chars.push({code:("00"+g.toString(16).toUpperCase()).slice(-2),hex:"00000000000000000000000000000000"})}};e.getCharAt=function(g,i){var h=i*e.charsPerRow+g;if(h<e.chars.length){return e.chars[h]}else{return null}};e.setCharAt=function(g,j,i){var h=j*e.charsPerRow+g;if(h<e.chars.length){e.chars[h].code=i.code;e.chars[h].hex=i.hex}};e.doClearChar=function(){for(var h=0;h<e.settings.hexFontCharHeight;h++){for(var g=0;g<e.settings.hexFontCharWidth;g++){e.charArray[h][g]=0}}b.find(".hfe-editor-wrapper canvas").drawRect({fillStyle:e.settings.pixelEmptyColor,x:e.pixelStartX,y:e.pixelStartY,fromCenter:false,width:e.canvasEffectiveWidth,height:e.canvasEffectiveHeight});e.updateProps();e.updateListFromChar(e.selectedCharX,e.selectedCharY)};e.init()};a.hexfonted.prototype.msg={en:{}};a.fn.hexfonted=function(b){return this.each(function(){if(a(this).data("hexfonted")==undefined){var c=new a.hexfonted(this,b);a(this).data("hexfonted",c);c=null}})}}(jQuery));